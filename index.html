<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MySocial</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f2f5f9;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* ---------- CARDS ---------- */
.card{
  width:360px;
  background:#fff;
  padding:30px;
  border-radius:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
  text-align:center;
}

input{
  width:100%;
  padding:13px;
  margin:8px 0;
  border-radius:14px;
  border:1px solid #ddd;
}

button{
  width:100%;
  padding:13px;
  border:none;
  border-radius:14px;
  background:#007aff;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.link{
  margin-top:10px;
  color:#007aff;
  cursor:pointer;
}

.hidden{display:none}

/* ---------- HOME ---------- */
#home{
  width:95%;
  max-width:1000px;
  height:92vh;
  display:flex;
  flex-direction:column;
}

.navbar{
  background:#007aff;
  color:#fff;
  padding:14px 22px;
  border-radius:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.main{
  flex:1;
  background:#fff;
  border-radius:18px;
  margin-top:14px;
  padding:18px;
  display:flex;
  flex-direction:column;
}

#chatWindow{
  flex:1;
  overflow:auto;
  display:flex;
  flex-direction:column;
}

.msg{
  max-width:70%;
  padding:10px 14px;
  border-radius:18px;
  margin:6px 0;
  font-size:14px;
}

.self{
  background:#007aff;
  color:#fff;
  align-self:flex-end;
}

.other{
  background:#eee;
  align-self:flex-start;
}

.emoji{
  cursor:pointer;
  margin-right:6px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginCard" class="card">
  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div class="link" onclick="showRegister()">Create account</div>
</div>

<!-- REGISTER -->
<div id="registerCard" class="card hidden">
  <h2>Create Account</h2>
  <input id="regEmail" placeholder="Email">
  <input id="regPass" type="password" placeholder="Password">
  <button onclick="register()">Register</button>
  <div class="link" onclick="showLogin()">Back to login</div>
</div>

<!-- HOME -->
<div id="home" class="hidden">
  <div class="navbar">
    <strong>MySocial</strong>
    <button style="width:auto;background:#ff3b30;padding:6px 14px" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <div id="chatWindow"></div>
    <input id="chatInput" placeholder="Type message and press Enter">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
// üî¥ PUT YOUR REAL FIREBASE CONFIG HERE
 const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let unsubscribeChat = null;

/* NAV */
function showRegister(){
  registerCard.classList.remove("hidden");
  loginCard.classList.add("hidden");
}
function showLogin(){
  loginCard.classList.remove("hidden");
  registerCard.classList.add("hidden");
}

/* REGISTER */
function register(){
  auth.createUserWithEmailAndPassword(regEmail.value, regPass.value)
    .then(()=>alert("Account created"))
    .catch(e=>alert(e.message));
}

/* LOGIN */
function login(){
  auth.signInWithEmailAndPassword(loginEmail.value, loginPass.value)
    .catch(e=>alert(e.message));
}

/* LOGOUT */
function logout(){
  if(unsubscribeChat) unsubscribeChat();
  auth.signOut();
}

/* AUTH STATE ‚Äî HARD FIX */
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser = user;

    loginCard.classList.add("hidden");
    registerCard.classList.add("hidden");
    home.classList.remove("hidden");

    startChat(); // only starts AFTER login
  }else{
    currentUser = null;

    home.classList.add("hidden");
    loginCard.classList.remove("hidden");

    if(unsubscribeChat) unsubscribeChat();
  }
});

/* SEND MESSAGE ‚Äî HARD FIX */
function sendMessage(){
  if(!currentUser){
    alert("You must login first");
    return;
  }

  const text = chatInput.value.trim();
  if(!text) return;

  db.collection("messages").add({
    uid: currentUser.uid,
    text: text,
    reactions: {},
    time: Date.now()
  }).then(()=>{
    chatInput.value="";
  }).catch(e=>{
    alert("Send failed: "+e.message);
  });
}

/* ENTER KEY */
chatInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});

/* REALTIME CHAT ‚Äî HARD FIX */
function startChat(){
  if(!currentUser) return;

  if(unsubscribeChat) unsubscribeChat();

  unsubscribeChat = db.collection("messages")
    .orderBy("time")
    .onSnapshot(snapshot=>{
      chatWindow.innerHTML="";

      snapshot.forEach(doc=>{
        const m = doc.data();

        const div=document.createElement("div");
        div.className="msg "+(m.uid===currentUser.uid?"self":"other");

        const r=m.reactions||{};

        div.innerHTML=`
          <div>${m.text}</div>
          <div>
            üëç ${r.like||0}
            ‚ù§Ô∏è ${r.love||0}
            üòÇ ${r.laugh||0}
          </div>
          <div>
            <span class="emoji" onclick="react('${doc.id}','like')">üëç</span>
            <span class="emoji" onclick="react('${doc.id}','love')">‚ù§Ô∏è</span>
            <span class="emoji" onclick="react('${doc.id}','laugh')">üòÇ</span>
          </div>
        `;

        chatWindow.appendChild(div);
      });

      chatWindow.scrollTop = chatWindow.scrollHeight;
    });
}

/* REACT */
function react(id,type){
  const ref=db.collection("messages").doc(id);

  db.runTransaction(async t=>{
    const doc=await t.get(ref);
    const data=doc.data();
    const r=data.reactions||{};
    r[type]=(r[type]||0)+1;
    t.update(ref,{reactions:r});
  });
}
</script>
</body>
</html>
