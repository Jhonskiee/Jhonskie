<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mega Social</title>
<style>
body{margin:0;font-family:Arial;background:#f0f2f5}
.nav{background:#1877f2;color:white;padding:12px}
.container{max-width:900px;margin:auto;padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px}
button{padding:6px 12px;margin-top:5px;cursor:pointer}
input,textarea{width:100%;padding:8px;margin:5px 0}
img{max-width:100%;border-radius:8px}
</style>
</head>
<body>

<div class="nav">Mega Social</div>

<div id="auth" class="container">
<h3>Login / Signup</h3>
<input id="name" placeholder="Name">
<input id="email" placeholder="Email">
<input id="pass" type="password" placeholder="Password">
<button onclick="signup()">Signup</button>
<button onclick="login()">Login</button>
</div>

<div id="app" style="display:none" class="container">
<button onclick="logout()">Logout</button>

<div class="card">
<h3>Create Post</h3>
<textarea id="postText" placeholder="What's on your mind?"></textarea>
<input type="file" id="postImage">
<button onclick="createPost()">Post</button>
</div>

<div id="feed"></div>

<div class="card">
<h3>Private Chat</h3>
<input id="chatUser" placeholder="Other User UID">
<div id="messages"></div>
<input id="chatText" placeholder="Message">
<button onclick="sendMessage()">Send</button>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword,
signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
getFirestore, collection, addDoc, setDoc,
doc, updateDoc, getDoc, onSnapshot,
query, orderBy, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

// üî• PUT YOUR CONFIG HERE
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_BUCKET",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();

// AUTH
window.signup = async ()=>{
  const cred = await createUserWithEmailAndPassword(auth,email.value,pass.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    name:name.value,
    createdAt:serverTimestamp()
  });
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,pass.value);
};

window.logout = ()=>signOut(auth);

// CREATE POST
window.createPost = async ()=>{
  const user = auth.currentUser;
  let imageUrl="";

  if(postImage.files[0]){
    const imageRef = ref(storage,"posts/"+Date.now());
    await uploadBytes(imageRef,postImage.files[0]);
    imageUrl = await getDownloadURL(imageRef);
  }

  await addDoc(collection(db,"posts"),{
    uid:user.uid,
    text:postText.value,
    image:imageUrl,
    likes:[],
    createdAt:serverTimestamp()
  });

  postText.value="";
};

// REALTIME FEED
function loadFeed(){
  const q = query(collection(db,"posts"),orderBy("createdAt","desc"));
  onSnapshot(q,snap=>{
    feed.innerHTML="";
    snap.forEach(docSnap=>{
      const p = docSnap.data();
      feed.innerHTML+=`
        <div class="card">
          <p>${p.text}</p>
          ${p.image?`<img src="${p.image}">`:""}
          <button onclick="likePost('${docSnap.id}')">
            ‚ù§Ô∏è ${p.likes.length}
          </button>
          <div id="comments-${docSnap.id}"></div>
          <input placeholder="Comment"
          onkeypress="if(event.key==='Enter') addComment('${docSnap.id}',this.value)">
        </div>
      `;
      loadComments(docSnap.id);
    });
  });
}

// LIKE
window.likePost = async (id)=>{
  const refDoc = doc(db,"posts",id);
  const snap = await getDoc(refDoc);
  let likes = snap.data().likes;

  if(!likes.includes(auth.currentUser.uid)){
    likes.push(auth.currentUser.uid);
    await updateDoc(refDoc,{likes});
  }
};

// COMMENT
window.addComment = async (postId,text)=>{
  await addDoc(collection(db,"posts",postId,"comments"),{
    uid:auth.currentUser.uid,
    text,
    createdAt:serverTimestamp()
  });
};

// LOAD COMMENTS
function loadComments(postId){
  const q=query(collection(db,"posts",postId,"comments"),orderBy("createdAt"));
  onSnapshot(q,snap=>{
    let html="";
    snap.forEach(d=>{
      html+=`<p>üí¨ ${d.data().text}</p>`;
    });
    document.getElementById("comments-"+postId).innerHTML=html;
  });
}

// PRIVATE CHAT
window.sendMessage = async ()=>{
  const chatId = [auth.currentUser.uid,chatUser.value].sort().join("_");
  await addDoc(collection(db,"chats",chatId,"messages"),{
    from:auth.currentUser.uid,
    text:chatText.value,
    createdAt:serverTimestamp()
  });
  chatText.value="";
  loadMessages();
};

function loadMessages(){
  const chatId = [auth.currentUser.uid,chatUser.value].sort().join("_");
  const q=query(collection(db,"chats",chatId,"messages"),orderBy("createdAt"));
  onSnapshot(q,snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      messages.innerHTML+=`<div>${d.data().text}</div>`;
    });
  });
}

// INIT
onAuthStateChanged(auth,user=>{
  if(user){
    auth.style.display="none";
    app.style.display="block";
    loadFeed();
  }
});

</script>
</body>
</html>
