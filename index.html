<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>UltraMax Social</title>

<script type="module">

// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword,
signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
getFirestore, collection, addDoc, setDoc, getDoc,
doc, updateDoc, onSnapshot, query, where,
orderBy, serverTimestamp, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

import { getDatabase, ref as rRef, set }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// ======== CONFIG ========
const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();
const rtdb = getDatabase();

// ======== AUTH ========
window.signup = async ()=>{
  const cred = await createUserWithEmailAndPassword(auth,email.value,pass.value);
  await setDoc(doc(db,"users",cred.user.uid),{
    name:name.value,
    bio:"",
    photo:"",
    followers:[],
    following:[],
    createdAt:serverTimestamp()
  });
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,pass.value);
};

window.logout = ()=>signOut(auth);

// ======== PRESENCE ========
function presence(user){
  set(rRef(rtdb,"status/"+user.uid),{online:true});
}

// ======== PROFILE UPDATE ========
window.updateProfile = async ()=>{
  let photoURL="";
  if(profilePic.files[0]){
    const pRef = ref(storage,"profiles/"+auth.currentUser.uid);
    await uploadBytes(pRef,profilePic.files[0]);
    photoURL = await getDownloadURL(pRef);
  }
  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    bio:bio.value,
    photo:photoURL
  });
};

// ======== FOLLOW SYSTEM ========
window.followUser = async (uid)=>{
  await updateDoc(doc(db,"users",auth.currentUser.uid),{
    following:arrayUnion(uid)
  });
  await updateDoc(doc(db,"users",uid),{
    followers:arrayUnion(auth.currentUser.uid)
  });
};

// ======== CREATE POST ========
window.createPost = async ()=>{
  let img="";
  if(postImg.files[0]){
    const pRef=ref(storage,"posts/"+Date.now());
    await uploadBytes(pRef,postImg.files[0]);
    img=await getDownloadURL(pRef);
  }

  await addDoc(collection(db,"posts"),{
    uid:auth.currentUser.uid,
    text:postText.value,
    img,
    visibility:visibility.value,
    likes:[],
    createdAt:serverTimestamp()
  });

  postText.value="";
};

// ======== REALTIME FEED ========
function loadFeed(){
  const q=query(collection(db,"posts"),orderBy("createdAt","desc"));
  onSnapshot(q,snap=>{
    feed.innerHTML="";
    snap.forEach(d=>{
      const p=d.data();
      feed.innerHTML+=`
        <div class="card">
        <p>${p.text}</p>
        ${p.img?`<img src="${p.img}" width="100%">`:""}
        <button onclick="likePost('${d.id}')">‚ù§Ô∏è ${p.likes.length}</button>
        <button onclick="notify('${p.uid}')">üîî</button>
        </div>`;
    });
  });
}

// ======== LIKE ========
window.likePost=async(id)=>{
  await updateDoc(doc(db,"posts",id),{
    likes:arrayUnion(auth.currentUser.uid)
  });
};

// ======== PRIVATE CHAT ========
window.sendPrivate=async()=>{
  await addDoc(collection(db,"chats"),{
    from:auth.currentUser.uid,
    to:chatWith.value,
    text:privateMsg.value,
    createdAt:serverTimestamp()
  });
  privateMsg.value="";
};

function loadPrivate(){
  const q=query(collection(db,"chats"),
    where("to","==",auth.currentUser.uid));
  onSnapshot(q,snap=>{
    privateBox.innerHTML="";
    snap.forEach(d=>{
      privateBox.innerHTML+=`<div>${d.data().text}</div>`;
    });
  });
}

// ======== NOTIFICATIONS ========
window.notify=async(uid)=>{
  await addDoc(collection(db,"notifications"),{
    to:uid,
    from:auth.currentUser.uid,
    type:"like",
    createdAt:serverTimestamp()
  });
};

function loadNotifications(){
  const q=query(collection(db,"notifications"),
    where("to","==",auth.currentUser.uid));
  onSnapshot(q,snap=>{
    notifyBox.innerHTML="";
    snap.forEach(d=>{
      notifyBox.innerHTML+=`<div>New Notification</div>`;
    });
  });
}

// ======== INIT ========
onAuthStateChanged(auth,user=>{
  if(user){
    authDiv.style.display="none";
    appDiv.style.display="block";
    presence(user);
    loadFeed();
    loadPrivate();
    loadNotifications();
  }
});

</script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:20px}
.card{background:white;padding:15px;margin:10px 0;border-radius:8px}
button{padding:6px 12px;margin:4px}
</style>
</head>

<body>

<div id="authDiv">
<h2>UltraMax Login</h2>
<input id="name" placeholder="Name"><br>
<input id="email" placeholder="Email"><br>
<input id="pass" type="password" placeholder="Password"><br>
<button onclick="signup()">Signup</button>
<button onclick="login()">Login</button>
</div>

<div id="appDiv" style="display:none">

<button onclick="logout()">Logout</button>

<h3>Profile</h3>
<input id="bio" placeholder="Bio">
<input type="file" id="profilePic">
<button onclick="updateProfile()">Update</button>

<h3>Create Post</h3>
<textarea id="postText"></textarea><br>
<select id="visibility">
<option value="public">Public</option>
<option value="friends">Friends</option>
</select>
<input type="file" id="postImg"><br>
<button onclick="createPost()">Post</button>

<h3>Feed (Realtime)</h3>
<div id="feed"></div>

<h3>Private Chat</h3>
<input id="chatWith" placeholder="User ID"><br>
<div id="privateBox"></div>
<input id="privateMsg">
<button onclick="sendPrivate()">Send</button>

<h3>Notifications</h3>
<div id="notifyBox"></div>

</div>

</body>
</html>
