<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>MySocial Pro Chat</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f0f2f5;
}

/* LOGIN */
#authBox{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card{
  background:#fff;
  padding:30px;
  border-radius:16px;
  width:320px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  text-align:center;
}
input,textarea{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#1877f2;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:hover{background:#166fe0}

/* APP */
#app{display:none;height:100vh;flex-direction:column}
.topbar{
  background:#1877f2;
  color:#fff;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.main{
  flex:1;
  display:flex;
  overflow:hidden;
}

.sidebar{
  width:260px;
  background:#fff;
  border-right:1px solid #ddd;
  padding:10px;
  overflow-y:auto;
}
.friend{
  padding:10px;
  border-radius:10px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.friend:hover{background:#f0f2f5}
.online{color:green;font-size:12px}
.offline{color:#999;font-size:12px}

.chatArea{
  flex:1;
  display:flex;
  flex-direction:column;
}
.messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
}
.msg{
  max-width:70%;
  padding:10px 14px;
  border-radius:16px;
  margin-bottom:10px;
  position:relative;
}
.me{background:#1877f2;color:#fff;margin-left:auto}
.other{background:#e4e6eb}
.reactions{font-size:12px;margin-top:4px}

.inputBar{
  padding:10px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  gap:8px;
}
.inputBar input{flex:1;margin:0}
.smallBtn{width:auto;padding:10px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="authBox">
  <div class="card">
    <h2>MySocial</h2>
    <input id="email" placeholder="Email" />
    <input id="pass" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="register()" style="margin-top:6px;background:#42b72a">Create account</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <b>MySocial Pro</b>
    <button class="smallBtn" onclick="logout()" style="background:#ff4d4f">Logout</button>
  </div>

  <div class="main">
    <div class="sidebar">
      <input id="searchUser" placeholder="Search users..." />
      <div id="friends"></div>
    </div>

    <div class="chatArea">
      <div id="messages" class="messages"></div>
      <div class="inputBar">
        <input id="msgBox" placeholder="Type message + Enter" />
        <input type="file" id="imgUpload" />
        <button class="smallBtn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
// üî¥ PASTE YOUR FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();

let me=null;
let activeChat=null;

// AUTH
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value);
}
function register(){
  auth.createUserWithEmailAndPassword(email.value,pass.value)
  .then(u=>db.collection("users").doc(u.user.uid).set({
    email:email.value,
    online:true
  }));
}
function logout(){auth.signOut();}

// STATE

auth.onAuthStateChanged(async user=>{
  if(user){
    me=user;
    authBox.style.display="none";
    app.style.display="flex";

    await db.collection("users").doc(user.uid).set({online:true},{merge:true});
    loadUsers();
  }else{
    app.style.display="none";
    authBox.style.display="flex";
  }
});

// ONLINE STATUS
window.addEventListener("beforeunload",()=>{
  if(me) db.collection("users").doc(me.uid).set({online:false},{merge:true});
});

// LOAD USERS / FRIENDS
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    friends.innerHTML="";
    snap.forEach(doc=>{
      if(doc.id===me.uid) return;
      const d=doc.data();
      friends.innerHTML+=`
        <div class='friend' onclick="openChat('${doc.id}')">
          <span>${d.email}</span>
          <span class='${d.online?"online":"offline"}'>${d.online?"‚óè":"‚óã"}</span>
        </div>`;
    });
  });
}

// CHAT ID
function chatId(uid){
  return [me.uid,uid].sort().join("_");
}

// OPEN CHAT
function openChat(uid){
  activeChat=chatId(uid);
  listenMessages();
}

// REALTIME MESSAGES
function listenMessages(){
  db.collection("chats").doc(activeChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      messages.innerHTML="";
      snap.forEach(doc=>renderMsg(doc));
      messages.scrollTop=messages.scrollHeight;
    });
}

// SEND MESSAGE
async function sendMsg(){
  if(!msgBox.value && !imgUpload.files[0]) return;

  let imgUrl="";
  if(imgUpload.files[0]){
    const ref=storage.ref("chatImages/"+Date.now());
    await ref.put(imgUpload.files[0]);
    imgUrl=await ref.getDownloadURL();
  }

  await db.collection("chats").doc(activeChat)
    .collection("messages").add({
      uid:me.uid,
      text:msgBox.value,
      img:imgUrl,
      time:firebase.firestore.FieldValue.serverTimestamp(),
      reacts:{}
    });

  msgBox.value="";
  imgUpload.value="";
}

// ENTER KEY
msgBox.addEventListener("keypress",e=>{
  if(e.key==="Enter") sendMsg();
});

// RENDER MESSAGE
function renderMsg(doc){
  const d=doc.data();
  const mine=d.uid===me.uid;

  let reacts="";
  if(d.reacts){
    for(let r in d.reacts){
      reacts+=` ${r}${d.reacts[r].length}`;
    }
  }

  messages.innerHTML+=`
    <div class='msg ${mine?"me":"other"}'>
      ${d.text||""}
      ${d.img?`<br><img src='${d.img}' style='max-width:200px;border-radius:10px'>`:""}
      <div class='reactions'>
        <span onclick="react('${doc.id}','üëç')">üëç</span>
        <span onclick="react('${doc.id}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="react('${doc.id}','üòÇ')">üòÇ</span>
        ${reacts}
      </div>
    </div>`;
}

// REACTIONS REALTIME
async function react(id,emoji){
  const ref=db.collection("chats").doc(activeChat)
    .collection("messages").doc(id);

  const doc=await ref.get();
  const data=doc.data();
  data.reacts=data.reacts||{};
  data.reacts[emoji]=data.reacts[emoji]||[];

  if(!data.reacts[emoji].includes(me.uid))
    data.reacts[emoji].push(me.uid);

  await ref.update({reacts:data.reacts});
}
</script>
</body>
</html>
