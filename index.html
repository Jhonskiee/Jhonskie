<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Next Level Realtime Chat</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDKs (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>MySocial Pro Chat</title>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#f0f2f5;
}
/* LOGIN */
#authBox{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.card{
  background:#fff;
  padding:30px;
  border-radius:16px;
  width:320px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  text-align:center;
}
input,textarea{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#1877f2;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:hover{background:#166fe0}
/* APP */
#app{display:none;height:100vh;flex-direction:column}
.topbar{
  background:#1877f2;
  color:#fff;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.main{
  flex:1;
  display:flex;
  overflow:hidden;
}
.sidebar{
  width:260px;
  background:#fff;
  border-right:1px solid #ddd;
  padding:10px;
  overflow-y:auto;
}
.friend{
  padding:10px;
  border-radius:10px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
}
.friend:hover{background:#f0f2f5}
.online{color:green;font-size:12px}
.offline{color:#999;font-size:12px}
.chatArea{
  flex:1;
  display:flex;
  flex-direction:column;
}
.messages{
  flex:1;
  overflow-y:auto;
  padding:20px;
}
.msg{
  max-width:70%;
  padding:10px 14px;
  border-radius:16px;
  margin-bottom:10px;
  position:relative;
}
.me{background:#1877f2;color:#fff;margin-left:auto}
.other{background:#e4e6eb}
.reactions{font-size:12px;margin-top:4px}
.inputBar{
  padding:10px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
  gap:8px;
}
.inputBar input{flex:1;margin:0}
.smallBtn{width:auto;padding:10px}
</style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex items-center justify-center">
  <!-- LOGIN CARD -->
  <div id="loginView" class="w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
      <h1 class="text-2xl font-bold mb-2">Realtime Social Chat</h1>
      <p class="text-gray-500 mb-6">Sign in to continue</p>
      <input id="email" type="email" placeholder="Email"
        class="w-full mb-3 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <input id="password" type="password" placeholder="Password"
        class="w-full mb-4 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <button onclick="login()"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold mb-3">
        Login
      </button>
      <button onclick="register()"
        class="w-full bg-gray-800 hover:bg-black text-white py-3 rounded-xl font-semibold">
        Create Account
      </button>
      <p id="authStatus" class="text-sm mt-4 text-red-500"></p>
    </div>
<body>
<!-- LOGIN -->
<div id="authBox">
  <div class="card">
    <h2>MySocial</h2>
    <input id="email" placeholder="Email" />
    <input id="pass" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <button onclick="register()" style="margin-top:6px;background:#42b72a">Create account</button>
  </div>
</div>

  <!-- CHAT APP -->
  <div id="appView" class="hidden w-full h-screen flex">
    <!-- SIDEBAR -->
    <div class="w-72 bg-white border-r flex flex-col">
      <div class="p-4 border-b">
        <h2 class="font-bold text-lg">Chats</h2>
        <p id="userEmail" class="text-xs text-gray-500"></p>
      </div>
      <div class="p-3 border-b">
        <input id="roomInput" placeholder="Room name (e.g. general)"
          class="w-full px-3 py-2 border rounded-lg" />
        <button onclick="joinRoom()"
          class="w-full mt-2 bg-blue-600 text-white py-2 rounded-lg">Join Room</button>
      </div>
<!-- APP -->
<div id="app">
  <div class="topbar">
    <b>MySocial Pro</b>
    <button class="smallBtn" onclick="logout()" style="background:#ff4d4f">Logout</button>
  </div>

      <button onclick="logout()"
        class="m-3 mt-auto bg-red-500 text-white py-2 rounded-lg">Logout</button>
  <div class="main">
    <div class="sidebar">
      <input id="searchUser" placeholder="Search users..." />
      <div id="friends"></div>
    </div>

    <!-- MAIN CHAT -->
    <div class="flex-1 flex flex-col">
      <!-- HEADER -->
      <div class="bg-white border-b p-4 font-semibold" id="roomTitle">No room joined</div>
      <!-- MESSAGES -->
      <div id="messages"
        class="flex-1 overflow-y-auto p-6 space-y-3 bg-slate-50"></div>
      <!-- INPUT -->
      <div class="bg-white border-t p-4 flex gap-2">
        <input id="messageInput" placeholder="Type message and press Enter..."
          class="flex-1 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button onclick="sendMessage()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl">Send</button>
    <div class="chatArea">
      <div id="messages" class="messages"></div>
      <div class="inputBar">
        <input id="msgBox" placeholder="Type message + Enter" />
        <input type="file" id="imgUpload" />
        <button class="smallBtn" onclick="sendMsg()">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
  // üî• TODO: PUT YOUR FIREBASE CONFIG HERE
  const firebaseConfig = {
// üî¥ PASTE YOUR FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentRoom = null;
  let unsubscribe = null;
  // ================= AUTH =================
  function register() {
    const email = emailInput();
    const pass = passInput();
    auth.createUserWithEmailAndPassword(email, pass)
      .then(() => setStatus("Account created!", true))
      .catch(e => setStatus(e.message));
  }
  function login() {
    const email = emailInput();
    const pass = passInput();
    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => setStatus(e.message));
  }
  function logout() {
    auth.signOut();
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const storage=firebase.storage();
let me=null;
let activeChat=null;
// AUTH
function login(){
  auth.signInWithEmailAndPassword(email.value,pass.value);
}
function register(){
  auth.createUserWithEmailAndPassword(email.value,pass.value)
  .then(u=>db.collection("users").doc(u.user.uid).set({
    email:email.value,
    online:true
  }));
}
function logout(){auth.signOut();}
// STATE
auth.onAuthStateChanged(async user=>{
  if(user){
    me=user;
    authBox.style.display="none";
    app.style.display="flex";
    await db.collection("users").doc(user.uid).set({online:true},{merge:true});
    loadUsers();
  }else{
    app.style.display="none";
    authBox.style.display="flex";
  }
  auth.onAuthStateChanged(user => {
    if (user) {
      loginView.classList.add("hidden");
      appView.classList.remove("hidden");
      userEmail.textContent = user.email;
    } else {
      appView.classList.add("hidden");
      loginView.classList.remove("hidden");
      if (unsubscribe) unsubscribe();
    }
});
// ONLINE STATUS
window.addEventListener("beforeunload",()=>{
  if(me) db.collection("users").doc(me.uid).set({online:false},{merge:true});
});
// LOAD USERS / FRIENDS
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    friends.innerHTML="";
    snap.forEach(doc=>{
      if(doc.id===me.uid) return;
      const d=doc.data();
      friends.innerHTML+=`
        <div class='friend' onclick="openChat('${doc.id}')">
          <span>${d.email}</span>
          <span class='${d.online?"online":"offline"}'>${d.online?"‚óè":"‚óã"}</span>
        </div>`;
    });
  });
}
// CHAT ID
function chatId(uid){
  return [me.uid,uid].sort().join("_");
}
// OPEN CHAT
function openChat(uid){
  activeChat=chatId(uid);
  listenMessages();
}
// REALTIME MESSAGES
function listenMessages(){
  db.collection("chats").doc(activeChat)
    .collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      messages.innerHTML="";
      snap.forEach(doc=>renderMsg(doc));
      messages.scrollTop=messages.scrollHeight;
    });
}

  // ================= ROOMS =================
  function joinRoom() {
    const room = roomInput.value.trim();
    if (!room) return;
    currentRoom = room;
    roomTitle.textContent = "Room: " + room;
    messages.innerHTML = "";
    if (unsubscribe) unsubscribe();
// SEND MESSAGE
async function sendMsg(){
  if(!msgBox.value && !imgUpload.files[0]) return;

    unsubscribe = db.collection("rooms")
      .doc(room)
      .collection("messages")
      .orderBy("time")
      .onSnapshot(snapshot => {
        messages.innerHTML = "";
        snapshot.forEach(doc => renderMessage(doc.id, doc.data()));
        scrollBottom();
      });
  let imgUrl="";
  if(imgUpload.files[0]){
    const ref=storage.ref("chatImages/"+Date.now());
    await ref.put(imgUpload.files[0]);
    imgUrl=await ref.getDownloadURL();
  }

  // ================= SEND =================
  function sendMessage() {
    if (!currentRoom) return alert("Join a room first");
    const text = messageInput.value.trim();
    if (!text) return;
  await db.collection("chats").doc(activeChat)
    .collection("messages").add({
      uid:me.uid,
      text:msgBox.value,
      img:imgUrl,
      time:firebase.firestore.FieldValue.serverTimestamp(),
      reacts:{}
    });

    const user = auth.currentUser;
  msgBox.value="";
  imgUpload.value="";
}

    db.collection("rooms")
      .doc(currentRoom)
      .collection("messages")
      .add({
        text,
        user: user.email,
        time: firebase.firestore.FieldValue.serverTimestamp(),
        reactions: {}
      });
// ENTER KEY
msgBox.addEventListener("keypress",e=>{
  if(e.key==="Enter") sendMsg();
});

    messageInput.value = "";
  }
// RENDER MESSAGE
function renderMsg(doc){
  const d=doc.data();
  const mine=d.uid===me.uid;

  // ENTER KEY SEND
  document.addEventListener("keydown", e => {
    if (e.key === "Enter" && document.activeElement === messageInput) {
      sendMessage();
  let reacts="";
  if(d.reacts){
    for(let r in d.reacts){
      reacts+=` ${r}${d.reacts[r].length}`;
    }
  });
  // ================= REACTIONS =================
  function react(msgId, emoji) {
    const ref = db.collection("rooms")
      .doc(currentRoom)
      .collection("messages")
      .doc(msgId);
    db.runTransaction(async t => {
      const doc = await t.get(ref);
      const data = doc.data();
      const reactions = data.reactions || {};
      reactions[emoji] = (reactions[emoji] || 0) + 1;
      t.update(ref, { reactions });
    });
  }

  // ================= UI =================
  function renderMessage(id, data) {
    const div = document.createElement("div");
    div.className = "bg-white p-3 rounded-xl shadow";
    const reacts = data.reactions || {};
    div.innerHTML = `
      <div class="text-xs text-gray-500">${data.user}</div>
      <div class="text-sm mb-2">${escapeHtml(data.text)}</div>
      <div class="flex gap-2 text-sm">
        <button onclick="react('${id}','üëç')">üëç ${reacts['üëç']||0}</button>
        <button onclick="react('${id}','‚ù§Ô∏è')">‚ù§Ô∏è ${reacts['‚ù§Ô∏è']||0}</button>
        <button onclick="react('${id}','üòÇ')">üòÇ ${reacts['üòÇ']||0}</button>
  messages.innerHTML+=`
    <div class='msg ${mine?"me":"other"}'>
      ${d.text||""}
      ${d.img?`<br><img src='${d.img}' style='max-width:200px;border-radius:10px'>`:""}
      <div class='reactions'>
        <span onclick="react('${doc.id}','üëç')">üëç</span>
        <span onclick="react('${doc.id}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="react('${doc.id}','üòÇ')">üòÇ</span>
        ${reacts}
      </div>
    `;
    </div>`;
}

    messages.appendChild(div);
  }
  function scrollBottom() {
    messages.scrollTop = messages.scrollHeight;
  }
// REACTIONS REALTIME
async function react(id,emoji){
  const ref=db.collection("chats").doc(activeChat)
    .collction("messages").doc(id);

  function setStatus(msg, ok=false) {
    authStatus.textContent = msg;
    authStatus.className = ok ? "text-green-600" : "text-red-500";
  }
  const doc=await ref.get();
  const data=doc.data();
  data.reacts=data.reacts||{};
  data.reacts[emoji]=data.reacts[emoji]||[];

  function emailInput() { return document.getElementById("email").value; }
  function passInput() { return document.getElementById("password").value; }
  if(!data.reacts[emoji].includes(me.uid))
    data.reacts[emoji].push(me.uid);

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }
  await ref.update({reacts:data.reacts});
}
</script>
</body>
  </html>
