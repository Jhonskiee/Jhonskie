<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pro Social Chat</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Calibri,sans-serif;
  background:#eef2f7;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.card{
  width:420px;
  background:#fff;
  padding:30px;
  border-radius:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}

.hidden{display:none}

input,textarea{
  width:100%;
  padding:11px;
  margin:8px 0;
  border-radius:10px;
  border:1.5px solid #ccc;
  font-size:14px;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#1877f2;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* ===== HOME ===== */
#home{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
  background:#f0f2f5;
}

.topbar{
  background:#1877f2;
  color:#fff;
  padding:14px 20px;
  font-size:20px;
  font-weight:700;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.layout{
  flex:1;
  display:grid;
  grid-template-columns:260px 1fr 320px;
  gap:16px;
  padding:16px;
}

.panel{
  background:#fff;
  border-radius:14px;
  padding:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  overflow:auto;
}

.feed-post{
  border:1px solid #eee;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}

.reactions span{
  cursor:pointer;
  margin-right:10px;
  font-size:18px;
}

.chat-box{
  height:320px;
  overflow:auto;
  border:1px solid #eee;
  border-radius:10px;
  padding:8px;
  margin-bottom:8px;
  background:#fafafa;
}

.friend-item{
  padding:8px;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
}

.center-text{
  text-align:center;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="card">
  <h2 class="center-text">Login</h2>
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <button style="margin-top:8px;background:#42b72a" onclick="register()">Create Account</button>
</div>

<!-- HOME -->
<div id="home" class="hidden">
  <div class="topbar">
    <div>Pro Social</div>
    <button style="width:auto;padding:6px 12px;background:#fff;color:#1877f2" onclick="logout()">Logout</button>
  </div>

  <div class="layout">

    <!-- FRIENDS -->
    <div class="panel">
      <h3>Find Friends</h3>
      <input id="searchUser" placeholder="Search email" oninput="searchUsers()" />
      <div id="searchResults"></div>

      <h3 style="margin-top:12px">My Friends</h3>
      <div id="friendsList"></div>
    </div>

    <!-- FEED -->
    <div class="panel">
      <h3>Create Post</h3>
      <textarea id="postText" placeholder="What's on your mind?"></textarea>
      <button onclick="createPost()">Post</button>

      <h3 style="margin-top:14px">Realtime Feed</h3>
      <div id="feed"></div>
    </div>

    <!-- CHAT -->
    <div class="panel">
      <h3>Realtime Chat</h3>
      <div id="chatBox" class="chat-box"></div>
      <input id="chatMsg" placeholder="Type message + Enter" />
      <button onclick="sendMessage()">Send</button>
    </div>

  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* üî• PUT YOUR REAL CONFIG HERE */
const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

/* ===== AUTH ===== */
window.register = async () => {
  await createUserWithEmailAndPassword(auth, email.value, password.value);
};

window.login = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value);
};

window.logout = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    login.classList.add("hidden");
    home.classList.remove("hidden");
    initRealtime();
  } else {
    currentUser = null;
    home.classList.add("hidden");
    login.classList.remove("hidden");
  }
});

/* ===== POSTS REALTIME ===== */
window.createPost = async () => {
  if (!postText.value.trim()) return;
  await addDoc(collection(db, "posts"), {
    text: postText.value,
    uid: currentUser.uid,
    time: serverTimestamp(),
    likes: 0
  });
  postText.value = "";
};

/* ===== CHAT REALTIME ===== */
window.sendMessage = async () => {
  if (!chatMsg.value.trim()) return;
  await addDoc(collection(db, "messages"), {
    text: chatMsg.value,
    uid: currentUser.uid,
    time: serverTimestamp()
  });
  chatMsg.value = "";
};

chatMsg.addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

/* ===== FRIEND SEARCH ===== */
window.searchUsers = async () => {
  searchResults.innerHTML = "Searching...";

  const q = query(collection(db, "users"));
  const snap = await getDocs(q);

  searchResults.innerHTML = "";
  snap.forEach(d => {
    const u = d.data();
    if (u.email.includes(searchUser.value) && u.uid !== currentUser.uid) {
      searchResults.innerHTML += `
        <div class="friend-item">
          <span>${u.email}</span>
          <button onclick="addFriend('${u.uid}')">Add</button>
        </div>`;
    }
  });
};

window.addFriend = async (uid) => {
  await setDoc(doc(db, "friends", currentUser.uid + "_" + uid), {
    users: [currentUser.uid, uid]
  });
  alert("Friend added realtime");
};

/* ===== REALTIME INIT ===== */
function initRealtime() {

  // save self profile
  setDoc(doc(db, "users", currentUser.uid), {
    uid: currentUser.uid,
    email: currentUser.email
  });

  // realtime posts
  const pq = query(collection(db, "posts"), orderBy("time", "desc"));
  onSnapshot(pq, snap => {
    feed.innerHTML = "";
    snap.forEach(d => {
      const p = d.data();
      feed.innerHTML += `
        <div class="feed-post">
          <b>${p.uid.slice(0,6)}</b><br>
          ${p.text}
          <div class="reactions">
            <span onclick="react('${d.id}')">üëç</span>
          </div>
        </div>`;
    });
  });

  // realtime chat
  const cq = query(collection(db, "messages"), orderBy("time"));
  onSnapshot(cq, snap => {
    chatBox.innerHTML = "";
    snap.forEach(d => {
      const m = d.data();
      chatBox.innerHTML += `<div><b>${m.uid.slice(0,6)}:</b> ${m.text}</div>`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* ===== REACTION ===== */
window.react = async (postId) => {
  const ref = doc(db, "posts", postId);
  await setDoc(ref, { likes: 1 }, { merge: true });
};

</script>
</body>
</html>
