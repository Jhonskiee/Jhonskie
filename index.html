<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Next Level Realtime Chat</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen flex items-center justify-center">

  <!-- LOGIN CARD -->
  <div id="loginView" class="w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
      <h1 class="text-2xl font-bold mb-2">Realtime Social Chat</h1>
      <p class="text-gray-500 mb-6">Sign in to continue</p>

      <input id="email" type="email" placeholder="Email"
        class="w-full mb-3 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <input id="password" type="password" placeholder="Password"
        class="w-full mb-4 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />

      <button onclick="login()"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold mb-3">
        Login
      </button>

      <button onclick="register()"
        class="w-full bg-gray-800 hover:bg-black text-white py-3 rounded-xl font-semibold">
        Create Account
      </button>

      <p id="authStatus" class="text-sm mt-4 text-red-500"></p>
    </div>
  </div>

  <!-- CHAT APP -->
  <div id="appView" class="hidden w-full h-screen flex">

    <!-- SIDEBAR -->
    <div class="w-72 bg-white border-r flex flex-col">
      <div class="p-4 border-b">
        <h2 class="font-bold text-lg">Chats</h2>
        <p id="userEmail" class="text-xs text-gray-500"></p>
      </div>

      <div class="p-3 border-b">
        <input id="roomInput" placeholder="Room name (e.g. general)"
          class="w-full px-3 py-2 border rounded-lg" />
        <button onclick="joinRoom()"
          class="w-full mt-2 bg-blue-600 text-white py-2 rounded-lg">Join Room</button>
      </div>

      <button onclick="logout()"
        class="m-3 mt-auto bg-red-500 text-white py-2 rounded-lg">Logout</button>
    </div>

    <!-- MAIN CHAT -->
    <div class="flex-1 flex flex-col">

      <!-- HEADER -->
      <div class="bg-white border-b p-4 font-semibold" id="roomTitle">No room joined</div>

      <!-- MESSAGES -->
      <div id="messages"
        class="flex-1 overflow-y-auto p-6 space-y-3 bg-slate-50"></div>

      <!-- INPUT -->
      <div class="bg-white border-t p-4 flex gap-2">
        <input id="messageInput" placeholder="Type message and press Enter..."
          class="flex-1 px-4 py-3 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button onclick="sendMessage()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl">Send</button>
      </div>
    </div>
  </div>

<script>
  // üî• TODO: PUT YOUR FIREBASE CONFIG HERE
  const firebaseConfig = {
    apiKey: "AIzaSyBc-ie4WnBkVMfrb5halHIaKWHGyy3zGC4",
    authDomain: "website-ab5ea.firebaseapp.com",
    projectId: "website-ab5ea",
    storageBucket: "website-ab5ea.firebasestorage.app",
    messagingSenderId: "1094491609955",
    appId: "1:1094491609955:web:4ac93d44c03490cd3d5156"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentRoom = null;
  let unsubscribe = null;

  // ================= AUTH =================

  function register() {
    const email = emailInput();
    const pass = passInput();

    auth.createUserWithEmailAndPassword(email, pass)
      .then(() => setStatus("Account created!", true))
      .catch(e => setStatus(e.message));
  }

  function login() {
    const email = emailInput();
    const pass = passInput();

    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => setStatus(e.message));
  }

  function logout() {
    auth.signOut();
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      loginView.classList.add("hidden");
      appView.classList.remove("hidden");
      userEmail.textContent = user.email;
    } else {
      appView.classList.add("hidden");
      loginView.classList.remove("hidden");
      if (unsubscribe) unsubscribe();
    }
  });

  // ================= ROOMS =================

  function joinRoom() {
    const room = roomInput.value.trim();
    if (!room) return;

    currentRoom = room;
    roomTitle.textContent = "Room: " + room;
    messages.innerHTML = "";

    if (unsubscribe) unsubscribe();

    unsubscribe = db.collection("rooms")
      .doc(room)
      .collection("messages")
      .orderBy("time")
      .onSnapshot(snapshot => {
        messages.innerHTML = "";
        snapshot.forEach(doc => renderMessage(doc.id, doc.data()));
        scrollBottom();
      });
  }

  // ================= SEND =================

  function sendMessage() {
    if (!currentRoom) return alert("Join a room first");

    const text = messageInput.value.trim();
    if (!text) return;

    const user = auth.currentUser;

    db.collection("rooms")
      .doc(currentRoom)
      .collection("messages")
      .add({
        text,
        user: user.email,
        time: firebase.firestore.FieldValue.serverTimestamp(),
        reactions: {}
      });

    messageInput.value = "";
  }

  // ENTER KEY SEND
  document.addEventListener("keydown", e => {
    if (e.key === "Enter" && document.activeElement === messageInput) {
      sendMessage();
    }
  });

  // ================= REACTIONS =================

  function react(msgId, emoji) {
    const ref = db.collection("rooms")
      .doc(currentRoom)
      .collection("messages")
      .doc(msgId);

    db.runTransaction(async t => {
      const doc = await t.get(ref);
      const data = doc.data();
      const reactions = data.reactions || {};

      reactions[emoji] = (reactions[emoji] || 0) + 1;
      t.update(ref, { reactions });
    });
  }

  // ================= UI =================

  function renderMessage(id, data) {
    const div = document.createElement("div");
    div.className = "bg-white p-3 rounded-xl shadow";

    const reacts = data.reactions || {};

    div.innerHTML = `
      <div class="text-xs text-gray-500">${data.user}</div>
      <div class="text-sm mb-2">${escapeHtml(data.text)}</div>
      <div class="flex gap-2 text-sm">
        <button onclick="react('${id}','üëç')">üëç ${reacts['üëç']||0}</button>
        <button onclick="react('${id}','‚ù§Ô∏è')">‚ù§Ô∏è ${reacts['‚ù§Ô∏è']||0}</button>
        <button onclick="react('${id}','üòÇ')">üòÇ ${reacts['üòÇ']||0}</button>
      </div>
    `;

    messages.appendChild(div);
  }

  function scrollBottom() {
    messages.scrollTop = messages.scrollHeight;
  }

  function setStatus(msg, ok=false) {
    authStatus.textContent = msg;
    authStatus.className = ok ? "text-green-600" : "text-red-500";
  }

  function emailInput() { return document.getElementById("email").value; }
  function passInput() { return document.getElementById("password").value; }

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
